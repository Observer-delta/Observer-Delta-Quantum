<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Δ = Observer Delta</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --bg: #000; --text: #0f0; --accent: #0f0; --warn: #f55; }
    [data-theme="light"] { --bg: #fff; --text: #000; --accent: #00f; --warn: #f00; }
    body { 
      margin:0; padding:0; font-family: 'Segoe UI', sans-serif; 
      background:var(--bg); color:var(--text); min-height:100vh;
      transition: background 0.5s, color 0.5s;
    }
    header { 
      text-align:center; padding:20px; border-bottom:1px solid var(--accent);
      position:relative;
    }
    h1 { 
      font-size:1.8em; margin:0; text-shadow:0 0 10px var(--accent);
      animation: glow 2s infinite alternate;
    }
    @keyframes glow { from { text-shadow:0 0 10px var(--accent); } to { text-shadow:0 0 20px var(--accent); } }
    nav { display:flex; justify-content:center; gap:15px; margin:15px 0; }
    button { 
      background:transparent; color:var(--text); border:1px solid var(--accent); 
      padding:10px 16px; border-radius:8px; cursor:pointer; font-size:1em;
      transition: all 0.3s;
    }
    button:hover { background:var(--accent); color:var(--bg); }
    button.active { background:var(--accent); color:var(--bg); }
    button.warn { background:var(--warn); animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    .container { padding:20px; max-width:600px; margin:auto; }
    .card { 
      background:rgba(255,255,255,0.05); border:1px solid var(--accent); 
      border-radius:12px; padding:15px; margin:15px 0; text-align:center;
    }
    canvas { width:100%; max-width:500px; height:150px; background:#111; border-radius:8px; }
    #result { 
      font-family:monospace; font-size:1.1em; line-height:1.6; 
      padding:10px; border-radius:8px; margin-top:10px;
      min-height:60px;
    }
    .pulse-text { animation: pulse 1.5s infinite; }
    #status { font-size:0.9em; opacity:0.8; margin:10px 0; }
    #install-btn { display:none; }
    footer { text-align:center; padding:20px; font-size:0.8em; opacity:0.6; }
    .switch { position:relative; display:inline-block; width:50px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#333; transition:.4s; border-radius:34px; }
    .slider:before { position:absolute; content:""; height:18px; width:18px; left:4px; bottom:4px; background:var(--bg); transition:.4s; border-radius:50%; }
    input:checked + .slider { background:var(--accent); }
    input:checked + .slider:before { transform:translateX(24px); }
  </style>
</head>
<body>
  <header>
    <h1>Δ = Observer Delta</h1>
    <p>Quantum CHSH + Real-Time Solar Flares</p>
  </header>

  <nav>
    <button id="tab-quantum" class="active">Quantum</button>
    <button id="tab-solar">Solar</button>
    <label class="switch" style="margin-left:auto;">
      <input type="checkbox" id="theme-toggle">
      <span class="slider"></span>
    </label>
  </nav>

  <div class="container">
    <div id="quantum-panel">
      <div class="card">
        <p>Noise Level (γ): <span id="noise-value">0.005</span></p>
        <input type="range" id="noise-slider" min="0" max="0.1" step="0.001" value="0.005" style="width:100%;">
        <button id="collapse">Collapse Now</button>
        <div id="result"></div>
      </div>
    </div>

    <div id="solar-panel" style="display:none;">
      <div class="card">
        <button id="update-solar">Update Solar Data</button>
        <div id="flare-status">Fetching...</div>
        <canvas id="flux-chart"></canvas>
        <p><small>NOAA GOES X-ray Flux (1-min)</small></p>
      </div>
    </div>

    <div id="status"></div>
    <button id="install-btn">Install App</button>
  </div>

  <footer>
    100% Offline • Built with Pyodide • <a href="https://github.com/observer-delta/Observer-Delta-Quantum" style="color:var(--accent);">GitHub</a>
  </footer>

  <!-- Pyodide -->
  <script src="pyodide/pyodide.js"></script>

  <script type="module">
    import { loadPyodide } from "./pyodide/pyodide.js";

    let pyodide, deferredPrompt;
    const quantumPanel = document.getElementById('quantum-panel');
    const solarPanel = document.getElementById('solar-panel');
    const result = document.getElementById('result');
    const status = document.getElementById('status');
    const collapseBtn = document.getElementById('collapse');
    const updateSolarBtn = document.getElementById('update-solar');
    const flareStatus = document.getElementById('flare-status');
    const canvas = document.getElementById('flux-chart');
    const ctx = canvas.getContext('2d');
    const noiseSlider = document.getElementById('noise-slider');
    const noiseValue = document.getElementById('noise-value');
    const installBtn = document.getElementById('install-btn');

    // Theme
    document.getElementById('theme-toggle').addEventListener('change', (e) => {
      document.documentElement.setAttribute('data-theme', e.target.checked ? 'light' : 'dark');
    });

    // Tabs
    document.getElementById('tab-quantum').onclick = () => switchTab('quantum');
    document.getElementById('tab-solar').onclick = () => switchTab('solar');
    function switchTab(tab) {
      document.querySelectorAll('#tab-quantum, #tab-solar').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      quantumPanel.style.display = tab === 'quantum' ? 'block' : 'none';
      solarPanel.style.display = tab === 'solar' ? 'block' : 'none';
    }

    // PWA Install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
      installBtn.onclick = () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          installBtn.style.display = 'none';
        });
      };
    });

    // Pyodide Init
    async function initPyodide() {
      status.textContent = 'Loading quantum engine...';
      try {
        pyodide = await loadPyodide({ indexURL: "./pyodide/" });
        await pyodide.loadPackage("numpy");
        status.textContent = 'Quantum engine ready!';
        setTimeout(() => status.style.opacity = '0.6', 2000);
        collapseBtn.disabled = false;
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.style.color = 'var(--warn)';
      }
    }

    // Quantum Collapse
    collapseBtn.onclick = async () => {
      if (!pyodide) return;
      const gamma = parseFloat(noiseSlider.value);
      collapseBtn.disabled = true;
      collapseBtn.textContent = "Collapsing...";
      result.innerHTML = "";

      try {
        const code = `
import numpy as np
from numpy.linalg import norm

psi = np.array([1,0,0,1]) / np.sqrt(2)
a1, a2 = 0, np.pi/4
b1, b2 = np.pi/8, 3*np.pi/8

def projector(theta):
    return np.array([[np.cos(theta)**2, np.cos(theta)*np.sin(theta)],
                     [np.cos(theta)*np.sin(theta), np.sin(theta)**2]])

A1 = np.kron(np.eye(2), projector(a1))
A2 = np.kron(np.eye(2), projector(a2))
B1 = np.kron(projector(b1), np.eye(2))
B2 = np.kron(projector(b2), np.eye(2))

def corr(A, B, rho):
    return np.real(np.trace(A @ B @ rho))

rho = np.outer(psi, psi.conj())
rho = (1 - gamma) * rho + gamma * np.eye(4)/4

S = corr(A1,B1,rho) + corr(A1,B2,rho) + corr(A2,B1,rho) - corr(A2,B2,rho)
f"S = {S:.4f}\\nSPOOKY LINK " + ("SURVIVED" if abs(S)>2 else "BROKEN")
        `;
        const output = await pyodide.runPythonAsync(code);
        result.innerHTML = output.replace("SURVIVED", "<span class='pulse-text'>SURVIVED</span>").replace("BROKEN", "<span style='color:var(--warn)'>BROKEN</span>");
      } catch (e) {
        result.textContent = "Error: " + e.message;
      } finally {
        collapseBtn.textContent = "Collapse Again";
        collapseBtn.disabled = false;
      }
    };

    noiseSlider.oninput = () => noiseValue.textContent = noiseSlider.value;

    // Solar Data
    let fluxData = [];
    async function fetchSolar() {
      flareStatus.textContent = "Updating...";
      try {
        const resp = await fetch('https://services.swpc.noaa.gov/json/goes/primary/xrays-1-minute.json');
        const data = await resp.json();
        const now = Date.now();
        fluxData = data
          .map(p => ({ t: new Date(p.time_tag).getTime(), f: parseFloat(p.flux) }))
          .filter(p => p.f > 1e-10 && now - p.t < 1800000)
          .sort((a,b) => a.t - b.t);
        drawChart();
        predictFlare();
      } catch {
        flareStatus.textContent = "Failed — retrying...";
        setTimeout(fetchSolar, 10000);
      }
    }

    function drawChart() {
      if (fluxData.length < 2) return;
      const [minT, maxT] = [Math.min(...fluxData.map(p=>p.t)), Math.max(...fluxData.map(p=>p.t))];
      const [minF, maxF] = [Math.min(...fluxData.map(p=>p.f)), Math.max(...fluxData.map(p=>p.f))];
      const w = canvas.width = 500, h = canvas.height = 150;
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle = 'var(--accent)'; ctx.lineWidth = 2;
      ctx.beginPath();
      fluxData.forEach((p,i) => {
        const x = 50 + (p.t - minT)/(maxT - minT) * (w - 100);
        const y = 120 - (p.f - minF)/(maxF - minF) * 80;
        i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function predictFlare() {
      if (fluxData.length < 10) return;
      const recent = fluxData.slice(-5);
      const slope = (recent[4].f - recent[0].f) / ((recent[4].t - recent[0].t)/60000);
      const prob = Math.min(99, Math.max(0, 10 + 50 * slope));
      flareStatus.innerHTML = `Flare Risk (30 min): <b>${prob.toFixed(1)}%</b>`;
      if (prob > 60) {
        collapseBtn.classList.add('warn');
        flareStatus.style.color = 'var(--warn)';
      } else {
        collapseBtn.classList.remove('warn');
        flareStatus.style.color = 'var(--text)';
      }
    }

    updateSolarBtn.onclick = fetchSolar;
    setInterval(fetchSolar, 120000);
    initPyodide().then(() => setTimeout(fetchSolar, 1000));
  </script>
</body>
</html>
